# Home Assistant Add-on Configuration
# https://developers.home-assistant.io/docs/add-ons/configuration

name: KingKiosk Core 3
version: "1.0.0"
slug: kingkiosk_core3
description: High-performance media kiosk platform with WebRTC, remote browser control, SIP/VoIP, AI analysis, and Home Assistant integration
url: "https://github.com/ajarsm/kingkiosk-ha-addon"

# Build configuration
arch:
  - amd64
  - aarch64

# Docker image from GitHub Container Registry
image: "ghcr.io/ajarsm/kingkiosk-core3-{arch}"

# Startup configuration
init: false
startup: services
boot: auto

# Resource configuration
timeout: 300

# Port mappings
# Note: host_network=true so all ports are accessible directly.
# These declarations are for documentation / HA UI display only.
ports:
  4000/tcp: 4000      # HTTP + WebSocket
  8554/tcp: 8554      # RTSP
ports_description:
  4000/tcp: "Web interface and WebSocket signaling"
  8554/tcp: "RTSP streaming"
# Additional ports used (via host_network, no mapping needed):
#   40000-49999/udp  - MediaSoup RTP (WebRTC, browser sessions, intercom)
#   55000-65000/udp  - SIP RTP media (when SIP is enabled)

# Device access for hardware acceleration
devices:
  - /dev/dri  # Intel/AMD VAAPI

# Privileges required for browser/media
privileged:
  - SYS_ADMIN         # Required for Chrome sandboxing workaround

# AppArmor profile
apparmor: true

# Host network for WebRTC (RTP ports)
host_network: true

# Audio support
audio: true

# Video device access
video: true

# Map add-on configuration to environment variables
map:
  - share:rw          # /share for recordings
  - ssl:ro            # /ssl for certificates
  - config:ro         # /config for Home Assistant config access

# Options schema (exposed in UI)
options:
  log_level: info
  server_port: 4000
  # go2rtc integration (RTSP export)
  # Example:
  #   go2rtc_url: "rtsp://192.168.0.199:8554"
  #   go2rtc_api_url: "http://192.168.0.199:1984"
  go2rtc_url: ""
  go2rtc_api_url: ""
  # MQTT configuration
  mqtt_enabled: true
  mqtt_host: ""
  mqtt_port: 1883
  mqtt_username: ""
  mqtt_password: ""
  mqtt_discovery_prefix: homeassistant
  # Media/WebRTC
  announced_ip: ""
  # Browser sessions
  browser_enabled: true
  browser_max_sessions: 5
  # ML features
  ml_quality_detection: false
  # Home Assistant bridge
  ha_bridge_enabled: false

schema:
  log_level: list(trace|debug|info|warn|error)
  server_port: port
  go2rtc_url: str?
  go2rtc_api_url: str?
  mqtt_enabled: bool
  mqtt_host: str?
  mqtt_port: port?
  mqtt_username: str?
  mqtt_password: password?
  mqtt_discovery_prefix: str
  announced_ip: str?
  browser_enabled: bool
  browser_max_sessions: int(1,20)
  ml_quality_detection: bool
  ha_bridge_enabled: bool

# Environment variables (auto-populated)
environment:
  RUST_LOG: "info"

# Service discovery
discovery:
  - mqtt

# Auth integration (use HA auth)
auth_api: true

# API access for HA bridge (WebSocket + REST)
homeassistant_api: true
hassio_api: true

# Ingress configuration (web UI proxy)
ingress: true
ingress_port: 4000
ingress_stream: true
panel_icon: mdi:television
panel_title: KingKiosk
panel_admin: true

# Labels
labels:
  io.hass.type: addon
  io.hass.name: KingKiosk Core 3
  io.hass.description: Media kiosk platform with WebRTC and AI
